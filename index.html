<html lang="fr">
  <meta charset="utf8">
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {

        var C = document.getElementById('capital').value * 1; // capital
        var T = document.getElementById('taux').value/100; // taux
        var N = document.getElementById('duree').value*12; // nombre de mensualités

        var assurance = parseInt(document.getElementById('assurance').value); // assurance mensuelle

        var M = (C*T/12)/(1-Math.pow((1+T/12), -N)); // mensualité du prêt principal

        var PTZ_C = document.getElementById('ptzMontant').value * 1; // montant du PTZ
        if (document.getElementById('enable_ptz').checked != true) {
          PTZ_C = 0;
        }
        var PTZ_N = document.getElementById('ptzDuree').value * 12; // nb mensualités du ptz
        var PTZ_O = document.getElementById('ptzCarence').value * 12; // offset du ptz
        var PTZ_end = PTZ_N + PTZ_O;
        var PTZ_M = PTZ_C / PTZ_N; // au moins, ça c'est facile à calculer. Mensu du PTZ

        var mydata = [["Mois", 'Capital dû', "Intérêts cumulés", 'Amortissement', 'Intérêts', 'Assurance', 'PTZ']];
        if (PTZ_C == 0) {
          mydata[0].pop(); // unset "PTZ" key
        }
        var interets, capital, amortissement, row, ptz;
        capital = C;
        var interetsCumules = 0.00;
        for (var i=0; i < N; i++) {
          interets = capital * T / 12;
          interetsCumules += interets;
          amortissement = M - interets;
          capital -= amortissement;
          ptz = 0;
          if (PTZ_C > 0 && i >= PTZ_O && i < PTZ_end) {
            ptz = PTZ_M;
          }

          row = [i, capital, interetsCumules, amortissement, interets, assurance, ptz ];
          if (PTZ_C == 0) {
            row.pop(); // unset PTZ key
          }
          mydata.push(row);
        }
        var data = google.visualization.arrayToDataTable(mydata);

        var options = {
          series: {
            0: {
              type: 'line',
              targetAxisIndex: 1
            },
            1: {
              type: 'line',
              targetAxisIndex: 1
            }
          },
          axes: {
            1: {
              title:'Gros montants'
            }
          },
          isStacked: true
        };

        var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
        var assuranceCumulee = assurance * N;
        var total = interetsCumules + assuranceCumulee;
        document.getElementById('total').innerHTML = total.toLocaleString() + ' €';
        document.getElementById('totalInterets').innerHTML = interetsCumules.toLocaleString() + ' €';
        document.getElementById('totalAssurance').innerHTML = assuranceCumulee.toLocaleString() + ' €';
        document.getElementById('nbDeMensualites').innerHTML = N;
        document.getElementById('montantMensualite').innerHTML = (M+assurance).toLocaleString() + ' €';
        document.getElementById('montantMensualitePendantPtz').innerHTML = (M+assurance+PTZ_M).toLocaleString() + ' €';

        document.getElementById('mensuPTZ').innerHTML = (PTZ_M).toLocaleString() + ' €';



        chart.draw(data, options);
      }
      function enablePtz() {
        var checkbox = document.getElementById('enable_ptz');
        console.log(checkbox.checked);
        document.body.classList.toggle('with-ptz', checkbox.checked);
      }
    </script>
    <style>
      body {
        font-family: sans-serif;
        margin: 1em;
      }
      h1 {
        border-bottom: 3px double;
        padding: .2em 0 .5em;
      }
      input {
        background: #fff;
        padding: .5em;
        font-size: 1em;
        border: 1px solid #ccc;
        width: 5em;
        text-align: right;
      }
      .gros { /* GROS MONTANT ! $OU$ !!! */
        width: 9em;
      }
      button {
        border-radius: .7em;
        padding: .5em 1.3em;
        font-size: 1em;
        background: linear-gradient(to bottom, #eee, #bbb)
      }
      button:hover {
        background: linear-gradient(to bottom, #eee, #999)
      }
      .result {
        font-weight: bold;
      }
      .ptz {
        display: none;
      }
      .with-ptz .ptz {
        display: initial;
      }
    </style>
  </head>
  <body class="no-ptz">
    <h1>Visualisateur d'échéancier de prêt <span class="ptz">avec <abbr title="Prêt à Taux Zéro">PTZ</abbr></span></h1>
    <div class="tooltip-right">
      <input type="checkbox" id="enable_ptz" onChange="enablePtz();"><label for="enable_ptz">Simuler un prêt à taux zéro</label>
    </div>
    <div>
      <p>J'emprunte <input id="capital" class="gros" type="number"> € au taux de <input id="taux" type="text"> % sur <input id="duree" type="number"> ans.</p>
      <p>Je prévois <input type="number" id="assurance"> € d'assurance par mois.</p>
      <p class="ptz">J'ai aussi un <abbr title="Prêt à Taux Zéro">PTZ</abbr> d'un montant de <input type="text" class="gros" id="ptzMontant"> € à rembourser en <input type="text" id="ptzDuree"> ans après une carence de <input type="text" id="ptzCarence"> ans.</p>
      <p><button onClick="drawChart()">Calculer</button></p>
    </div>
    <div class="results">
      <p><span class="result" id="nbDeMensualites"></span> mensualités de <span class="result" id="montantMensualite"></span></p>
      <p class="ptz">Les mensualités du PTZ sont de <span class="result" id="mensuPTZ"></span> (donc les mensualités pendant le remboursement du PTZ seront de <span class="result" id="montantMensualitePendantPtz"></span>).</p>
      <p>Montant total du prêt : <span class="result" id="total"></span> dont <span class="result" id="totalInterets"></span> d'intérêts et <span class="result" id="totalAssurance"></span> d'assurance.</p>
    </div>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <script>
      enablePtz();
    </script>
  </body>
</html>
